DELIMITER $$
CREATE PROCEDURE checkTime(IN T varchar(50), out T1 varchar(50))
BEGIN
    IF T not like '____-__-__%' THEN
		set T1 = "incorrect timestamp";
    ELSEIF T > (Select distinct SUBSTRING_INDEX(SUBSTRING_INDEX(timestamp, ':', 2), ' ', 1) from Penna order by timestamp desc limit 1) THEN
		set T1 = (Select distinct timestamp from Penna order by timestamp desc limit 1);
	ELSEIF T < (Select distinct SUBSTRING_INDEX(SUBSTRING_INDEX(timestamp, ':', 2), ' ', 1) from Penna order by timestamp asc limit 1) THEN
		set T1 = '0';
	ELSE
		set T1 = (Select distinct timestamp from Penna where SUBSTRING_INDEX(SUBSTRING_INDEX(timestamp, ':', 2), ' ', 1) = T order by timestamp desc limit 1);
	end if;
END; $$
DELIMITER ;


DELIMITER $$
CREATE PROCEDURE API2(IN date varchar(50), out candidate varchar(50))
BEGIN
declare votes_Biden int default 0;
declare votes_Trump int default 0;
	call checkTime(date, @t);
    if @t = 'incorrect timestamp' then
		set candidate = @t;
	elseif @t = '0' then
		set candidate = 'incorrect timestamp';
	else
		set votes_Biden = (select sum(Biden) from Penna where timestamp = @t);
        set votes_Trump = (select sum(Trump) from Penna where timestamp = @t);
        if (votes_Biden > votes_Trump) then
			set candidate = "Biden";
		elseif(votes_Biden < votes_Trump) then
			set candidate = "Trump";
		else
			set candidate = "tied";
		end if;
    end if;
END; $$
DELIMITER ;
